<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Therapeutic AI (Enhanced Vector)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8ecf0 100%);
            min-height: 100vh;
            color: #2c3e50;
        }
        
        .header {
            background: white;
            padding: 20px 24px;
            border-bottom: 1px solid #e8ecf0;
            box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4A90B8, #5DADE2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        
        .brand-text h1 {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .admin-badge {
            background: #f44336;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .version-badge {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .nav-links {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .nav-link {
            color: #4A90B8;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(74, 144, 184, 0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .dashboard-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(44, 62, 80, 0.08);
            border: 1px solid #e8ecf0;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .upload-icon {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }
        
        .debug-icon {
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
        }
        
        .rebuild-icon {
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
        }
        
        .batch-icon {
            background: rgba(127, 176, 105, 0.1);
            color: #7FB069;
        }
        
        .stats-icon {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }
        
        .authors-icon {
            background: rgba(74, 144, 184, 0.1);
            color: #4A90B8;
        }
        
        .health-icon {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .upload-area {
            border: 2px dashed #e8ecf0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #4A90B8;
            background: rgba(74, 144, 184, 0.02);
        }
        
        .upload-area.dragover {
            border-color: #4A90B8;
            background: rgba(74, 144, 184, 0.1);
        }
        
        .file-input {
            margin-bottom: 16px;
        }
        
        .file-input input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #e8ecf0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .upload-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .rebuild-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 16px;
        }
        
        .rebuild-btn:hover {
            background: #f57c00;
            transform: translateY(-1px);
        }
        
        .rebuild-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .debug-section {
            margin-top: 16px;
        }
        
        .debug-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e8ecf0;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .debug-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .debug-btn:hover {
            background: #f57c00;
            transform: translateY(-1px);
        }
        
        .debug-results {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
            white-space: pre-wrap;
            display: none;
            line-height: 1.4;
        }
        
        .batch-btn {
            background: #7FB069;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }
        
        .batch-btn:hover {
            background: #6fa055;
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .stat-item {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #4A90B8;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            color: #90a4ae;
            margin-top: 4px;
        }
        
        .authors-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
        }
        
        .author-tag {
            display: inline-block;
            background: #4A90B8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }
        
        .status-success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .status-error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e8ecf0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4A90B8, #7FB069);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }
        
        .health-status {
            font-size: 14px;
            color: #546e7a;
        }
        
        .health-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .health-item:last-child {
            border-bottom: none;
        }
        
        .health-label {
            font-weight: 500;
        }
        
        .health-value {
            color: #4A90B8;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .status-online {
            background: #4caf50;
        }
        
        .status-offline {
            background: #f44336;
        }
        
        .status-warning {
            background: #ff9800;
        }
        
        .feature-list {
            margin-top: 12px;
            padding: 12px;
            background: rgba(74, 144, 184, 0.05);
            border-radius: 8px;
            border-left: 4px solid #4A90B8;
        }
        
        .feature-list h4 {
            margin-bottom: 8px;
            color: #4A90B8;
            font-size: 14px;
        }
        
        .feature-list ul {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 2px 0;
            font-size: 13px;
            color: #546e7a;
        }
        
        .feature-list li:before {
            content: "‚úÖ ";
            margin-right: 6px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .container {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="brand">
                <div class="brand-icon">üîí</div>
                <div class="brand-text">
                    <h1>Admin Dashboard</h1>
                    <span class="version-badge">ENHANCED VECTOR v3.0</span>
                </div>
                <div class="admin-badge">ADMIN</div>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">‚Üê Back to Chat</a>
                <a href="/admin/batch-upload" class="nav-link">üìö Batch Upload</a>
                <a href="/health" class="nav-link" target="_blank">üè• Health Check</a>
                <a href="/admin/logout" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <div class="dashboard-grid">
            <!-- Single Upload Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon upload-icon">üìÑ</div>
                    <h2 class="card-title">Single Upload</h2>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="file-input">
                        <input type="file" id="pdfFile" accept=".pdf" />
                    </div>
                    <p style="color: #90a4ae; font-size: 14px; margin-bottom: 16px;">
                        Upload one PDF book or research paper (up to 200MB)<br>
                        <strong>Enhanced:</strong> Vector indexing + semantic search
                    </p>
                    <button id="uploadBtn" class="upload-btn">
                        üì§ Upload to Knowledge Base
                    </button>
                </div>
                
                <div id="uploadStatus" class="status-message" style="display: none;"></div>
                <div id="uploadProgress" class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>
            </div>

            <!-- DEBUG TOOLS Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon debug-icon">üîç</div>
                    <h2 class="card-title">Debug Knowledge Search</h2>
                </div>
                
                <p style="color: #546e7a; margin-bottom: 16px; font-size: 14px;">
                    Test the enhanced vector search and semantic retrieval system
                </p>
                
                <div class="debug-section">
                    <input type="text" id="debugQuery" class="debug-input" 
                           placeholder="Enter book title or search term (e.g., 'family therapy')" />
                    
                    <div>
                        <button onclick="debugKnowledgeSearch()" class="debug-btn">
                            üîç Test Search
                        </button>
                        <button onclick="debugSystemStatus()" class="debug-btn">
                            ‚öôÔ∏è System Status
                        </button>
                        <button onclick="testContextBuild()" class="debug-btn">
                            üìù Test Context
                        </button>
                    </div>
                    
                    <div id="debugResults" class="debug-results"></div>
                </div>
                
                <div class="feature-list">
                    <h4>Debug Features:</h4>
                    <ul>
                        <li>Vector search algorithm testing</li>
                        <li>Semantic similarity scoring</li>
                        <li>Real-time context building analysis</li>
                        <li>OpenAI embedding diagnostics</li>
                    </ul>
                </div>
            </div>

            <!-- NEW: Rebuild Vector Index Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon rebuild-icon">üîß</div>
                    <h2 class="card-title">Rebuild Vector Index</h2>
                </div>
                
                <p style="color: #546e7a; margin-bottom: 16px; font-size: 14px;">
                    Rebuild vector embeddings for all uploaded books. Use this after deploying or if search isn't finding your books.
                </p>
                
                <div class="feature-list">
                    <h4>What This Does:</h4>
                    <ul>
                        <li>Scans all uploaded books in database</li>
                        <li>Creates OpenAI embeddings for semantic search</li>
                        <li>Rebuilds ChromaDB vector indexes</li>
                        <li>Restores AI access to your book library</li>
                    </ul>
                </div>
                
                <button onclick="rebuildVectorIndex()" class="rebuild-btn" id="rebuildBtn">
                    üîß Rebuild All Vector Indexes
                </button>
                
                <div id="rebuildStatus" class="status-message" style="display: none;"></div>
                
                <div id="rebuildProgress" class="progress-bar" style="display: none;">
                    <div class="progress-fill" id="rebuildProgressFill">0%</div>
                </div>
            </div>

            <!-- Batch Upload Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon batch-icon">üìö</div>
                    <h2 class="card-title">Batch Upload System</h2>
                </div>
                
                <p style="color: #546e7a; margin-bottom: 16px;">
                    Upload multiple large therapeutic books at once with enhanced vector indexing.
                </p>
                
                <div class="feature-list">
                    <h4>Enhanced Features:</h4>
                    <ul>
                        <li>Support for 200MB+ PDFs</li>
                        <li>Up to 2000 pages per document</li>
                        <li>Automatic vector embedding creation</li>
                        <li>Real-time semantic indexing</li>
                        <li>Progress tracking with embedding status</li>
                    </ul>
                </div>
                
                <a href="/admin/batch-upload" class="batch-btn">
                    üöÄ Open Batch Upload Interface
                </a>
            </div>
            
            <!-- Statistics -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon stats-icon">üìä</div>
                    <h2 class="card-title">Knowledge Base Statistics</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number">{{ total_docs }}</span>
                        <div class="stat-label">Documents</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ (knowledge_base.get('total_characters', 0) / 1000000) | round(1) }}</span>
                        <div class="stat-label">Million Chars</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ authorized_authors | length }}</span>
                        <div class="stat-label">Authors</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ (knowledge_base.get('total_characters', 0) / 1024 / 1024) | round(1) }}</span>
                        <div class="stat-label">MB Data</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; font-size: 12px; color: #90a4ae; text-align: center;">
                    Last Updated: {{ knowledge_base.get('last_updated', 'Never')[:16] if knowledge_base.get('last_updated') else 'Never' }}
                </div>
                
                <div class="feature-list">
                    <h4>Vector Search Capabilities:</h4>
                    <ul>
                        <li>Semantic similarity matching</li>
                        <li>Up to 1MB context per document</li>
                        <li>Relevance scoring (0.0-1.0)</li>
                        <li>Multi-book cross-referencing</li>
                    </ul>
                </div>
            </div>
            
            <!-- Authorized Authors -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon authors-icon">üë®‚Äç‚öïÔ∏è</div>
                    <h2 class="card-title">Authorized Authors</h2>
                </div>
                
                <div class="authors-list">
                    {% if authorized_authors %}
                        {% for author in authorized_authors %}
                        <span class="author-tag">{{ author }}</span>
                        {% endfor %}
                    {% else %}
                        <p style="color: #90a4ae; text-align: center; padding: 20px; font-style: italic;">
                            No authors found yet. Upload therapeutic documents to automatically extract and authorize therapeutic experts.
                        </p>
                    {% endif %}
                </div>
                
                {% if authorized_authors %}
                <div style="margin-top: 12px; font-size: 12px; color: #90a4ae; text-align: center;">
                    AI can reference these {{ authorized_authors | length }} therapeutic experts with semantic search
                </div>
                {% endif %}
            </div>

            <!-- System Health Monitor -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-icon health-icon">üè•</div>
                    <h2 class="card-title">System Health Monitor</h2>
                </div>
                
                <div class="health-status" id="healthStatus">
                    <div class="health-item">
                        <span class="health-label">Status</span>
                        <span class="health-value">Loading...</span>
                    </div>
                </div>
                
                <button onclick="refreshHealth()" class="debug-btn" style="margin-top: 12px; width: 100%;">
                    üîÑ Refresh System Status
                </button>
                
                <div class="feature-list">
                    <h4>Enhanced Monitoring:</h4>
                    <ul>
                        <li>Claude + OpenAI API status</li>
                        <li>ChromaDB vector store health</li>
                        <li>Embedding generation diagnostics</li>
                        <li>Semantic search performance</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const uploadBtn = document.getElementById('uploadBtn');
        const pdfFile = document.getElementById('pdfFile');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadArea = document.getElementById('uploadArea');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                pdfFile.files = files;
            }
        });

        // Utility functions
        function showStatus(message, isSuccess) {
            uploadStatus.textContent = message;
            uploadStatus.className = `status-message ${isSuccess ? 'status-success' : 'status-error'}`;
            uploadStatus.style.display = 'block';
            setTimeout(() => uploadStatus.style.display = 'none', 8000);
        }

        function showProgress(percent) {
            uploadProgress.style.display = 'block';
            uploadProgress.querySelector('.progress-fill').style.width = percent + '%';
            if (percent >= 100) {
                setTimeout(() => uploadProgress.style.display = 'none', 1500);
            }
        }

        // Upload functionality
        uploadBtn.addEventListener('click', async () => {
            const file = pdfFile.files[0];
            if (!file) {
                showStatus('Please select a PDF file first', false);
                return;
            }
            if (file.type !== 'application/pdf') {
                showStatus('Please select a valid PDF file', false);
                return;
            }

            const fileSize = (file.size / 1024 / 1024).toFixed(1);
            const formData = new FormData();
            formData.append('pdf', file);
            formData.append('upload_type', 'admin');

            uploadBtn.disabled = true;
            uploadBtn.textContent = `‚è≥ Processing ${fileSize}MB...`;
            showProgress(0);

            try {
                showStatus(`Processing ${file.name} (${fileSize}MB) with vector indexing...`, true);
                showProgress(20);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                showProgress(70);
                const result = await response.json();
                showProgress(100);

                if (result.success) {
                    let message = `‚úÖ Successfully added '${file.name}' to knowledge base with vector indexing`;
                    message += `\nüìä Extracted ${result.character_count?.toLocaleString() || 'unknown'} characters`;
                    
                    if (result.extracted_authors && result.extracted_authors.length > 0) {
                        message += `\nüë®‚Äç‚öïÔ∏è Authors: ${result.extracted_authors.join(', ')}`;
                    }
                    
                    if (result.vector_indexed) {
                        message += `\nüîç Vector indexing: Success`;
                    }
                    
                    showStatus(message, true);
                    pdfFile.value = '';
                    
                    // Refresh page to update stats
                    setTimeout(() => window.location.reload(), 3000);
                } else {
                    showStatus(`‚ùå Upload failed: ${result.message || result.error}`, false);
                }
            } catch (error) {
                showProgress(100);
                showStatus(`‚ùå Upload failed: ${error.message}`, false);
                console.error('Upload error:', error);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload to Knowledge Base';
            }
        });

        // NEW: Rebuild Vector Index Function
        async function rebuildVectorIndex() {
            const rebuildBtn = document.getElementById('rebuildBtn');
            const rebuildStatus = document.getElementById('rebuildStatus');
            const rebuildProgress = document.getElementById('rebuildProgress');
            const progressFill = document.getElementById('rebuildProgressFill');
            
            // Show loading state
            rebuildBtn.disabled = true;
            rebuildBtn.textContent = 'üîÑ Rebuilding Indexes...';
            rebuildStatus.style.display = 'block';
            rebuildStatus.className = 'status-message status-success';
            rebuildStatus.textContent = 'Starting vector index rebuild...';
            rebuildProgress.style.display = 'block';
            
            // Animate progress bar
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 2;
                if (progress <= 90) {
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }
            }, 500);
            
            try {
                const response = await fetch('/rebuild-index', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                // Complete progress
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                if (result.success) {
                    rebuildStatus.className = 'status-message status-success';
                    let message = `‚úÖ Rebuild completed successfully!\n`;
                    message += `üìö Admin docs processed: ${result.stats.admin_docs_processed}\n`;
                    message += `üë§ User docs processed: ${result.stats.user_docs_processed}\n`;
                    
                    if (result.stats.admin_docs_failed > 0 || result.stats.user_docs_failed > 0) {
                        message += `‚ö†Ô∏è Failed: ${result.stats.admin_docs_failed + result.stats.user_docs_failed}\n`;
                    }
                    
                    rebuildStatus.textContent = message;
                    
                    // Refresh page after 3 seconds to update stats
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                    
                } else {
                    rebuildStatus.className = 'status-message status-error';
                    rebuildStatus.textContent = `‚ùå Rebuild failed: ${result.error}`;
                }
                
            } catch (error) {
                clearInterval(progressInterval);
                rebuildStatus.className = 'status-message status-error';
                rebuildStatus.textContent = `‚ùå Network error: ${error.message}`;
                console.error('Rebuild error:', error);
            } finally {
                rebuildBtn.disabled = false;
                rebuildBtn.textContent = 'üîß Rebuild All Vector Indexes';
                
                // Hide progress bar after 5 seconds
                setTimeout(() => {
                    rebuildProgress.style.display = 'none';
                }, 5000);
            }
        }

        // Debug functions
        async function debugKnowledgeSearch() {
            const query = document.getElementById('debugQuery').value.trim();
            const resultsDiv = document.getElementById('debugResults');
            
            if (!query) {
                alert('Please enter a search term (e.g., book title)');
                return;
            }
            
            try {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = 'Searching knowledge base with vector search...';
                
                const response = await fetch('/debug-knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    resultsDiv.textContent = `‚ùå ERROR: ${result.error}`;
                    return;
                }
                
                let output = `üîç VECTOR SEARCH DEBUG RESULTS\n`;
                output += `=====================================\n`;
                output += `Query: "${result.search_query}"\n`;
                output += `Total Documents in KB: ${result.total_documents}\n`;
                output += `Context Generated: ${result.generated_context_length?.toLocaleString()} characters\n`;
                output += `Timestamp: ${new Date().toISOString()}\n\n`;
                
                output += `üìö ALL DOCUMENTS IN KNOWLEDGE BASE:\n`;
                output += `${'='.repeat(50)}\n`;
                if (result.all_documents && result.all_documents.length > 0) {
                    result.all_documents.forEach((doc, i) => {
                        output += `${i + 1}. "${doc.filename}"\n`;
                        output += `   üìÑ Characters: ${doc.character_count?.toLocaleString() || 'Unknown'}\n`;
                        if (doc.authors && doc.authors.length > 0) {
                            output += `   üë®‚Äç‚öïÔ∏è Authors: ${doc.authors.join(', ')}\n`;
                        }
                        output += `   üìù Preview: ${doc.content_preview || 'No preview'}\n`;
                        output += `   ${'‚îÄ'.repeat(40)}\n`;
                    });
                } else {
                    output += `‚ùå No documents found in knowledge base!\n`;
                }
                
                if (result.context_preview) {
                    output += `\nüìù GENERATED CONTEXT PREVIEW:\n`;
                    output += `${'='.repeat(40)}\n`;
                    output += `${result.context_preview}\n`;
                    output += `${'='.repeat(40)}\n`;
                }
                
                if (result.knowledge_base_stats) {
                    output += `\nüìä KNOWLEDGE BASE STATISTICS:\n`;
                    output += `${'='.repeat(35)}\n`;
                    output += `Total Characters: ${result.knowledge_base_stats.total_characters?.toLocaleString() || 'Unknown'}\n`;
                    output += `Total Authors: ${result.knowledge_base_stats.total_authors || 0}\n`;
                    output += `Last Updated: ${result.knowledge_base_stats.last_updated || 'Never'}\n`;
                    output += `Storage Size: ${((result.knowledge_base_stats.total_characters || 0) / 1024 / 1024).toFixed(2)} MB\n`;
                }
                
                output += `\n‚úÖ Vector search algorithm working!\n`;
                resultsDiv.textContent = output;
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå ERROR: ${error.message}\n\nFull error: ${error.stack}`;
                console.error('Debug search error:', error);
            }
        }

        async function debugSystemStatus() {
            const resultsDiv = document.getElementById('debugResults');
            
            try {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = 'Checking complete system status...';
                
                const response = await fetch('/admin/debug-system');
                const result = await response.json();
                
                if (result.error) {
                    resultsDiv.textContent = `‚ùå ERROR: ${result.error}`;
                    return;
                }
                
                let output = `‚öôÔ∏è ENHANCED SYSTEM STATUS DEBUG\n`;
                output += `=====================================\n`;
                output += `System Status: ${result.system_status?.toUpperCase() || 'UNKNOWN'}\n`;
                output += `Timestamp: ${result.timestamp}\n`;
                output += `Version: Enhanced Vector Therapeutic AI v3.0\n\n`;
                
                output += `üìÅ DIRECTORY STATUS:\n`;
                output += `${'='.repeat(25)}\n`;
                if (result.directories) {
                    Object.entries(result.directories).forEach(([dir, info]) => {
                        const existsIcon = info.exists ? '‚úÖ' : '‚ùå';
                        const writableIcon = info.writable ? '‚úÖ' : '‚ùå';
                        output += `${dir}:\n`;
                        output += `  Exists: ${existsIcon} | Writable: ${writableIcon} | Items: ${info.contents}\n`;
                    });
                }
                
                output += `\nüìö KNOWLEDGE BASE FILE STATUS:\n`;
                output += `${'='.repeat(35)}\n`;
                if (result.knowledge_base_file) {
                    const kbf = result.knowledge_base_file;
                    output += `File Exists: ${kbf.file_exists ? '‚úÖ' : '‚ùå'}\n`;
                    output += `File Size: ${(kbf.file_size / 1024).toFixed(1)} KB\n`;
                    output += `Readable: ${kbf.readable ? '‚úÖ' : '‚ùå'}\n`;
                }
                
                output += `\nüìä KNOWLEDGE BASE ANALYSIS:\n`;
                output += `${'='.repeat(32)}\n`;
                if (result.knowledge_base_analysis) {
                    const kba = result.knowledge_base_analysis;
                    output += `Total Documents: ${kba.total_docs}\n`;
                    output += `Total Characters: ${kba.total_chars?.toLocaleString() || '0'}\n`;
                    output += `Storage Size: ${((kba.total_chars || 0) / 1024 / 1024).toFixed(2)} MB\n`;
                    output += `Authorized Authors: ${kba.authors}\n`;
                    output += `Last Updated: ${kba.last_updated || 'Never'}\n`;
                }
                
                output += `\nüíæ DATABASE STATISTICS:\n`;
                output += `${'='.repeat(25)}\n`;
                if (result.database_stats) {
                    const db = result.database_stats;
                    output += `Total Users: ${db.users}\n`;
                    output += `Total Conversations: ${db.conversations}\n`;
                    output += `Active User Documents: ${db.user_docs}\n`;
                    output += `Knowledge Base Docs: ${db.kb_docs}\n`;
                }
                
                if (result.memory_usage) {
                    output += `\nüß† MEMORY USAGE:\n`;
                    output += `${'='.repeat(15)}\n`;
                    output += `Python Process: ${result.memory_usage.python_process}\n`;
                    output += `GC Collections: ${JSON.stringify(result.memory_usage.gc_collections)}\n`;
                }
                
                output += `\n‚úÖ Enhanced system diagnostic complete!\n`;
                output += `All core systems operational with vector search.\n`;
                
                resultsDiv.textContent = output;
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå SYSTEM DEBUG ERROR: ${error.message}\n\nThis might indicate a server-side issue.\nFull error: ${error.stack}`;
                console.error('System debug error:', error);
            }
        }

        async function testContextBuild() {
            const query = document.getElementById('debugQuery').value.trim();
            const resultsDiv = document.getElementById('debugResults');
            
            if (!query) {
                alert('Please enter a search term to test context building');
                return;
            }
            
            try {
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = 'Testing enhanced context building system...';
                
                // This simulates what happens when a user asks a question
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_input: `Do you have access to information about: ${query}?`,
                        agent: 'therapist'
                    })
                });
                
                const result = await response.json();
                
                let output = `üìù CONTEXT BUILD TEST RESULTS\n`;
                output += `===============================\n`;
                output += `Test Query: "${query}"\n`;
                output += `AI Response Length: ${result.response?.length || 0} characters\n`;
                output += `Context Included: ${result.context_included ? '‚úÖ' : '‚ùå'}\n`;
                output += `Vector Enhanced: ${result.retrieval_enhanced ? '‚úÖ' : '‚ùå'}\n`;
                output += `Timestamp: ${new Date().toISOString()}\n\n`;
                
                output += `ü§ñ AI RESPONSE:\n`;
                output += `${'='.repeat(15)}\n`;
                output += `${result.response || result.error || 'No response'}\n`;
                output += `${'='.repeat(50)}\n`;
                
                if (result.error) {
                    output += `\n‚ùå ERROR OCCURRED:\n${result.error}\n`;
                } else {
                    output += `\n‚úÖ Enhanced context building test completed!\n`;
                    output += `The AI should now have vector-powered access to your books.\n`;
                }
                
                resultsDiv.textContent = output;
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå CONTEXT TEST ERROR: ${error.message}\n\nFull error: ${error.stack}`;
                console.error('Context test error:', error);
            }
        }

        // Health monitoring functions
        async function refreshHealth() {
            const healthDiv = document.getElementById('healthStatus');
            
            try {
                healthDiv.innerHTML = '<div class="health-item"><span class="health-label">Status</span><span class="health-value">Checking...</span></div>';
                
                const response = await fetch('/health');
                const health = await response.json();
                
                let healthHtml = '';
                
                // System status
                const statusIcon = health.status === 'healthy' ? 'status-online' : 'status-offline';
                healthHtml += `
                    <div class="health-item">
                        <span class="health-label"><span class="status-indicator ${statusIcon}"></span>System Status</span>
                        <span class="health-value">${health.status?.toUpperCase() || 'UNKNOWN'}</span>
                    </div>
                `;
                
                // Version
                if (health.version) {
                    healthHtml += `
                        <div class="health-item">
                            <span class="health-label">Version</span>
                            <span class="health-value">${health.version}</span>
                        </div>
                    `;
                }
                
                // API Status
                if (health.apis) {
                    const claudeIcon = health.apis.claude_working ? 'status-online' : (health.apis.claude_configured ? 'status-offline' : 'status-warning');
                    const openaiIcon = health.apis.openai_working ? 'status-online' : (health.apis.openai_configured ? 'status-offline' : 'status-warning');
                    
                    healthHtml += `
                        <div class="health-item">
                            <span class="health-label"><span class="status-indicator ${claudeIcon}"></span>Claude API</span>
                            <span class="health-value">${health.apis.claude_working ? 'Online' : (health.apis.claude_configured ? 'Offline' : 'Not Configured')}</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label"><span class="status-indicator ${openaiIcon}"></span>OpenAI API</span>
                            <span class="health-value">${health.apis.openai_working ? 'Online' : (health.apis.openai_configured ? 'Offline' : 'Not Configured')}</span>
                        </div>
                    `;
                }
                
                // Vector Store Status
                if (health.vector_store) {
                    const vectorIcon = health.vector_store.chromadb_initialized ? 'status-online' : 'status-offline';
                    healthHtml += `
                        <div class="health-item">
                            <span class="health-label"><span class="status-indicator ${vectorIcon}"></span>Vector Store</span>
                            <span class="health-value">${health.vector_store.total_indexed} indexed</span>
                        </div>
                    `;
                }
                
                // Database stats
                if (health.database) {
                    healthHtml += `
                        <div class="health-item">
                            <span class="health-label">Total Users</span>
                            <span class="health-value">${health.database.total_users}</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label">Conversations</span>
                            <span class="health-value">${health.database.total_conversations}</span>
                        </div>
                    `;
                }
                
                // Knowledge base
                if (health.knowledge_base) {
                    const kbStatus = health.knowledge_base.total_documents > 0 ? 'status-online' : 'status-warning';
                    healthHtml += `
                        <div class="health-item">
                            <span class="health-label"><span class="status-indicator ${kbStatus}"></span>Knowledge Base</span>
                            <span class="health-value">${health.knowledge_base.total_documents} docs (${health.knowledge_base.size_mb}MB)</span>
                        </div>
                    `;
                }
                
                healthDiv.innerHTML = healthHtml;
                
            } catch (error) {
                healthDiv.innerHTML = `
                    <div class="health-item">
                        <span class="health-label"><span class="status-indicator status-offline"></span>Health Check</span>
                        <span class="health-value">Failed: ${error.message}</span>
                    </div>
                `;
                console.error('Health check error:', error);
            }
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            // Refresh health status every 30 seconds
            setInterval(refreshHealth, 30000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + D for debug search
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                document.getElementById('debugQuery').focus();
            }
            
            // Enter key in debug input
            if (e.target.id === 'debugQuery' && e.key === 'Enter') {
                debugKnowledgeSearch();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Enhanced Vector Admin Dashboard v3.0 loaded');
            console.log('üîç Enhanced features available:');
            console.log('  - Vector search testing');
            console.log('  - Semantic similarity scoring');
            console.log('  - ChromaDB diagnostics');
            console.log('  - Vector index rebuilding');
            
            // Initial health check
            refreshHealth();
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Set focus on debug input for convenience
            setTimeout(() => {
                const debugInput = document.getElementById('debugQuery');
                if (debugInput && !document.querySelector('input[type="file"]:focus')) {
                    debugInput.placeholder = 'Try: "family therapy" or "Minuchin" or any therapeutic concept...';
                }
            }, 1000);
        });

        // Error handling for global errors
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            
            // Show error in debug results if visible
            const debugResults = document.getElementById('debugResults');
            if (debugResults && debugResults.style.display !== 'none') {
                debugResults.textContent += `\n\n‚ùå JAVASCRIPT ERROR: ${e.error.message}\n${e.error.stack}`;
            }
        });
    </script>
</body>
</html>
